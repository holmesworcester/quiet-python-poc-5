# Repository Guidelines

## Project Structure & Modules
- `core/`: Framework code (pipeline, db, crypto, identity, handlers). Avoid protocol-specific logic here.
- `protocols/quiet/`: Quiet protocol implementation
  - `handlers/`: Pipeline handlers (db read/write allowed)
  - `events/`: Event modules (commands, validators, projectors; pure functions)
  - `openapi.yaml`: API surface for operations
  - `tests/`: pytest suite (handlers, events, integration)
- `docs/`: Design notes and investigations
- `tests at repo root`: Misc sanity tests (e.g., network simulator)
- `requirements.txt`, `mypy.ini`, `README.md`

## Build, Test, Develop
```bash
# Setup
python -m venv venv && source venv/bin/activate
pip install -r requirements.txt

# Lint/Types
mypy --config-file mypy.ini

# Tests (entire suite or focused)
pytest -q
pytest protocols/quiet/tests/handlers -q
pytest test_network_simulator.py -q
```
Notes: `scripts/run_tests.sh` targets a prior POC; run `pytest` directly in this repo.

## Coding Style & Naming
- Python 3.11, 4-space indent, type hints required (strict mypy). Keep functions small and pure where indicated.
- Names: `snake_case` for functions/files, `PascalCase` for classes, constants `UPPER_SNAKE`.
- Formatting: follow standard Python style; prefer explicit returns and `dict[str, Any]` over `Dict` when possible.

## Architecture Rules (Important)
- Commands/Validators/Projectors: pure functions, no DB access.
- Handlers: may read/write DB; own their tables and filters.
- Queries: read-only (enforced via wrappers/decorators).
- Keep protocol-specific code under `protocols/quiet/`; keep `core/` generic.

## Testing Guidelines
- Framework: pytest with markers in `protocols/quiet/pytest.ini` (`unit`, `handler`, `integration`).
- Naming: `test_*.py`; mirror event/handler structure under `protocols/quiet/tests/`.
- Setup: For query tests, insert rows directly; do not call commands to seed data. For integration, use the pipeline/API and expect IDs to be generated by handlers.
- Follow RULES.md in tests
- Prefer scenario tests over integration tests for flows
- Prefer improving/updating existing tests using existing naming convention, where applicable

## Commits & PRs
- Commits: short, imperative subject; reference modules touched (e.g., "handlers/resolve_deps: unblock missing deps").
- PRs: include description, rationale, test coverage (new/updated tests), and any schema or `openapi.yaml` changes. Attach logs/screenshots for failing cases where helpful.

## Security & Config Tips
- SQLite files like `quiet.db`/`demo.db` are local artifacts; avoid committing them. Never commit secrets; keep sensitive values in `local_metadata` and ensure they are stripped before send.

