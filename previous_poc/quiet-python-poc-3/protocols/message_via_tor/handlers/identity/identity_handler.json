{
  "type": "identity",
  "projector": {
    "description": "Stores identity information including keypairs",
    "func": "projector.project",
    "tests": [
      {
        "given": {
          "db": {},
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "identity",
              "pubkey": "pub123",
              "privkey": "priv123",
              "name": "Alice"
            }
          }
        },
        "then": {
          "snapshot": {
            "identities": [
              {
                "pubkey": "pub123",
                "privkey": "priv123",
                "name": "Alice",
                "created_at": "*",
                "updated_at": "*"
              }
            ],
            "event_store": [
              {
                "event_type": "identity",
                "data": {
                  "type": "identity",
                  "pubkey": "pub123",
                  "privkey": "priv123",
                  "name": "Alice"
                }
              }
            ]
          }
        }
      }
    ]
  },
  "commands": {
    "create": {
      "description": "Creates an identity with keypair and peer",
      "func": "create.execute",
      "tests": [
        {
          "given": {
            "db": {},
            "params": {
              "name": "Bob"
            }
          },
          "then": {
            "return": {
              "api_response": {
                "identityId": "*",
                "publicKey": "*"
              },
              "newEvents": [
                {
                  "type": "identity",
                  "pubkey": "*",
                  "privkey": "*",
                  "name": "Bob"
                },
                {
                  "type": "peer",
                  "pubkey": "*",
                  "name": "Bob"
                }
              ]
            }
          }
        }
      ]
    },
    "list": {
      "description": "Lists all identities (without private keys)",
      "func": "list.execute",
      "tests": [
        {
          "given": {
            "db": {
              "identities": [
                {
                  "pubkey": "pub1",
                  "privkey": "priv1",
                  "name": "Alice"
                },
                {
                  "pubkey": "pub2",
                  "privkey": "priv2",
                  "name": "Bob"
                }
              ]
            },
            "params": {}
          },
          "then": {
            "return": {
              "api_response": {
                "identities": [
                  {
                    "identityId": "pub1",
                    "publicKey": "pub1",
                    "name": "Alice"
                  },
                  {
                    "identityId": "pub2",
                    "publicKey": "pub2",
                    "name": "Bob"
                  }
                ]
              }
            }
          }
        }
      ]
    },
    "invite": {
      "description": "Creates an invite link for sharing",
      "func": "invite.execute",
      "tests": [
        {
          "given": {
            "db": {
              "identities": [
                {
                  "pubkey": "pub123",
                  "privkey": "priv123",
                  "name": "Alice"
                }
              ]
            },
            "params": {
              "identityId": "pub123"
            }
          },
          "then": {
            "return": {
              "api_response": {
                "return": "Invite link created",
                "inviteLink": "*",
                "inviteData": {
                  "peer": "pub123",
                  "name": "Alice"
                }
              }
            }
          }
        }
      ]
    },
    "join": {
      "description": "Joins a network using an invite link",
      "func": "join.execute",
      "tests": [
        {
          "given": {
            "db": {},
            "params": {
              "inviteLink": "message-via-tor://invite/eyJuYW1lIjoiQWxpY2UiLCJwZWVyIjoicHViMTIzIn0=",
              "name": "Charlie"
            }
          },
          "then": {
            "return": {
              "api_response": {
                "return": "Joined network via invite",
                "identity": {
                  "pubkey": "*",
                  "name": "Charlie"
                },
                "peer": {
                  "pubkey": "pub123",
                  "name": "Alice"
                }
              },
              "newEvents": [
                {
                  "type": "identity",
                  "pubkey": "*",
                  "privkey": "*",
                  "name": "Charlie"
                },
                {
                  "type": "peer",
                  "pubkey": "*",
                  "name": "Charlie"
                },
                {
                  "type": "peer",
                  "pubkey": "pub123",
                  "name": "Alice",
                  "joined_via": "invite",
                  "received_by": "*"
                }
              ]
            }
          }
        },
        {
          "description": "Join creates identity in state after projecting events",
          "given": {
            "db": {},
            "params": {
              "inviteLink": "message-via-tor://invite/eyJuYW1lIjoiQm9iIiwicGVlciI6InB1YjQ1NiJ9",
              "name": "Alice"
            }
          },
          "ticks": 1,
          "then": {
            "return": {
              "api_response": {
                "return": "Joined network via invite",
                "identity": {
                  "pubkey": "*",
                  "name": "Alice"
                },
                "peer": {
                  "pubkey": "pub456",
                  "name": "Bob"
                }
              }
            },
            "snapshot": {
              "identities": [
                {
                  "pubkey": "*",
                  "name": "Alice",
                  "created_at": "*",
                  "updated_at": "*"
                }
              ],
              "peers": [
                {
                  "pubkey": "*",
                  "name": "Alice",
                  "added_at": "*"
                },
                {
                  "pubkey": "pub456",
                  "name": "Bob",
                  "added_at": "*"
                }
              ]
            }
          }
        },
        {
          "description": "Join sends peer event to inviter via outgoing queue",
          "given": {
            "db": {},
            "params": {
              "inviteLink": "message-via-tor://invite/eyJuYW1lIjoiQWxpY2UiLCJwZWVyIjoicHViMTIzIn0=",
              "name": "Charlie"
            }
          },
          "then": {
            "return": {
              "api_response": {
                "return": "Joined network via invite",
                "identity": {
                  "pubkey": "*",
                  "name": "Charlie"
                },
                "peer": {
                  "pubkey": "pub123",
                  "name": "Alice"
                }
              }
            },
            "snapshot": {
              "outgoing": [
                {
                  "recipient": "pub123",
                  "data": "*",
                  "created_at": "*",
                  "sent": false
                }
              ]
            }
          }
        }
      ]
    }
  }
}
