{
  "type": "incoming",
  "version": 1,
  "description": "Processes incoming messages for message_via_tor protocol (no encryption)",
  "commands": {
    "process_incoming": {
      "description": "Processes incoming message queue without decryption",
      "func": "process_incoming.execute",
      "tests": [
        {
          "description": "Pre-decrypted envelope from tor_simulator passes through unchanged",
          "given": {
            "db": {
              "incoming": [
                {
                  "recipient": "alice",
                  "data": {
                    "type": "message",
                    "text": "Test",
                    "sender": "alice"
                  },
                  "metadata": {
                    "origin": "network",
                    "receivedAt": 1000
                  },
                  "received_at": 1000
                }
              ]
            },
            "params": {
              "time_now_ms": 1000
            }
          },
          "then": {
            "snapshot": {
              "incoming": [],
              "event_store": [
                {
                  "event_type": "message",
                  "data": {
                    "type": "message",
                    "text": "Test",
                    "sender": "alice"
                  }
                }
              ]
            }
          }
        },
        {
          "description": "Multiple envelopes are processed in order",
          "given": {
            "db": {
              "incoming": [
                {
                  "recipient": "id1",
                  "data": {
                    "type": "message",
                    "text": "First",
                    "sender": "alice"
                  },
                  "metadata": {
                    "receivedAt": 1000
                  },
                  "received_at": 1000
                },
                {
                  "recipient": "id1",
                  "data": {
                    "type": "message",
                    "text": "Second",
                    "sender": "bob"
                  },
                  "metadata": {
                    "receivedAt": 2000
                  },
                  "received_at": 2000
                }
              ]
            },
            "params": {
              "time_now_ms": 3000
            }
          },
          "then": {
            "snapshot": {
              "incoming": [],
              "event_store": [
                {
                  "event_type": "message",
                  "data": {
                    "type": "message",
                    "text": "First",
                    "sender": "alice"
                  }
                },
                {
                  "event_type": "message",
                  "data": {
                    "type": "message",
                    "text": "Second",
                    "sender": "bob"
                  }
                }
              ]
            }
          }
        }
      ]
    }
  },
  "job": "process_incoming"
}