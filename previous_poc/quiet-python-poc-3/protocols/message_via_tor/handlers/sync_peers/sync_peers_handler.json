{
  "type": "sync_peers",
  "projector": {
    "description": "Validates sync request and sends all peer events to requester",
    "func": "projector.project",
    "tests": [
      {
        "skipIdempotency": true,
        "given": {
          "db": {
            "peers": [
              {
                "pubkey": "peer1",
                "name": "Alice",
                "received_by": "identity1"
              },
              {
                "pubkey": "peer2",
                "name": "Bob",
                "received_by": "identity1"
              }
            ],
            "event_store": [
              {
                "event_type": "peer",
                "event_id": "e1",
                "metadata": {
                  "selfGenerated": true,
                  "received_by": "identity1"
                },
                "event_data": {
                  "type": "peer",
                  "pubkey": "peer1",
                  "name": "Alice"
                },
                "pubkey": "identity1",
                "created_at": 0
              },
              {
                "event_type": "peer",
                "event_id": "e2",
                "metadata": {
                  "selfGenerated": true,
                  "received_by": "identity1"
                },
                "event_data": {
                  "type": "peer",
                  "pubkey": "peer2",
                  "name": "Bob"
                },
                "pubkey": "identity1",
                "created_at": 0
              }
            ]
          },
          "envelope": {
            "recipient": "identity1",
            "metadata": {
              "received_by": "identity1"
            },
            "payload": {
              "type": "sync_peers",
              "sender": "peer3"
            }
          }
        },
        "then": {
          "snapshot": {
            "peers": [
              {
                "pubkey": "peer1",
                "name": "Alice",
                "received_by": "identity1",
                "added_at": "*"
              },
              {
                "pubkey": "peer2",
                "name": "Bob",
                "received_by": "identity1",
                "added_at": "*"
              }
            ],
            "outgoing": [
              {
                "recipient": "peer3",
                "data": "*",
                "created_at": "*",
                "sent": false
              },
              {
                "recipient": "peer3",
                "data": "*",
                "created_at": "*",
                "sent": false
              }
            ]
          }
        }
      }
    ]
  },
  "commands": {
    "create": {
      "description": "Creates a sync-request event given a sender peer",
      "func": "create.execute",
      "tests": [
        {
          "given": {
            "db": {},
            "params": {
              "sender": "peer1"
            }
          },
          "then": {
            "return": {
              "return": "Sync request created",
              "newEvents": [
                {
                  "type": "sync_peers",
                  "sender": "peer1"
                }
              ]
            }
          }
        }
      ]
    },
    "send": {
      "description": "Sends a sync-request to a recipient peer via outgoing",
      "func": "send.execute",
      "tests": [
        {
          "given": {
            "db": {},
            "params": {
              "recipient": "peer2"
            }
          },
          "then": {
            "return": {
              "return": "Sync request sent to peer2"
            },
            "snapshot": {
              "outgoing": [
                {
                  "recipient": "peer2",
                  "data": "*",
                  "created_at": "*",
                  "sent": false
                }
              ]
            }
          }
        }
      ]
    },
    "sync_all": {
      "description": "Sends sync requests from all identities to all their known peers",
      "func": "sync_all.execute",
      "tests": [
        {
          "given": {
            "db": {
              "identities": [
                {
                  "pubkey": "id1",
                  "privkey": "id1_priv",
                  "name": "Identity1"
                },
                {
                  "pubkey": "id2",
                  "privkey": "id2_priv",
                  "name": "Identity2"
                }
              ],
              "peers": [
                {
                  "pubkey": "peer1",
                  "name": "Peer1",
                  "received_by": "id1"
                },
                {
                  "pubkey": "peer2",
                  "name": "Peer2",
                  "received_by": "id1"
                },
                {
                  "pubkey": "peer1",
                  "name": "Peer1",
                  "received_by": "id2"
                },
                {
                  "pubkey": "peer2",
                  "name": "Peer2",
                  "received_by": "id2"
                }
              ]
            },
            "params": {}
          },
          "then": {
            "return": {
              "return": "Sent sync requests from 2 identities to 2 peers"
            },
            "snapshot": {
              "outgoing": [
                {
                  "recipient": "peer1",
                  "data": "*",
                  "created_at": "*",
                  "sent": false
                },
                {
                  "recipient": "peer2",
                  "data": "*",
                  "created_at": "*",
                  "sent": false
                },
                {
                  "recipient": "peer1",
                  "data": "*",
                  "created_at": "*",
                  "sent": false
                },
                {
                  "recipient": "peer2",
                  "data": "*",
                  "created_at": "*",
                  "sent": false
                }
              ]
            }
          }
        }
      ]
    }
  },
  "job": "sync_all"
}
