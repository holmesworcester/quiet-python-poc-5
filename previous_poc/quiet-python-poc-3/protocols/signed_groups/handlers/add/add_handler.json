{
  "type": "add",
  "projector": {
    "description": "Projects add events - adds users to groups",
    "func": "projector.project",
    "tests": [
      {
        "description": "Valid add with existing group and users",
        "given": {
          "env": {
            "CRYPTO_MODE": "dummy"
          },
          "db": {
            "users": [
              {
                "id": "user_123",
                "pubkey": "user_123",
                "network_id": "net_123"
              },
              {
                "id": "user_456",
                "pubkey": "user_456",
                "network_id": "net_123"
              }
            ],
            "groups": [
              {
                "id": "group_123",
                "name": "Developers",
                "created_by": "user_123"
              }
            ]
          },
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "add",
              "id": "add_123",
              "group_id": "group_123",
              "user_id": "user_456",
              "added_by": "user_123",
              "signature": "dummy_sig_YWRkOmFkZF8xMjM6Z3JvdXBfMTIzOnVzZXJfNDU2OnVzZXJfMTIz_by_user_123"
            }
          }
        },
        "then": {
          "db": {
            "adds": [
              {
                "id": "add_123",
                "group_id": "group_123",
                "user_id": "user_456",
                "added_by": "user_123"
              }
            ]
          }
        }
      },
      {
        "description": "Add blocked when group doesn't exist",
        "given": {
          "db": {
            "users": [
              {
                "id": "user_123",
                "pubkey": "adder_pub",
                "network_id": "net_123"
              },
              {
                "id": "user_456",
                "pubkey": "member_pub",
                "network_id": "net_123"
              }
            ]
          },
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "add",
              "id": "add_456",
              "group_id": "nonexistent_group",
              "user_id": "user_456",
              "added_by": "user_123",
              "signature": "dummy_sig_YWRkOmFkZF80NTY6bm9uZXhpc3RlbnRfZ3JvdXA6dXNlcl80NTY6dXNlcl8xMjM=_by_creator_pub"
            }
          },
          "env": {
            "CRYPTO_MODE": "dummy"
          }
        },
        "then": {
          "db": {
            "adds": []
          }
        }
      },
      {
        "description": "Add blocked when user doesn't exist",
        "given": {
          "db": {
            "users": [
              {
                "id": "user_123",
                "pubkey": "adder_pub",
                "network_id": "net_123"
              }
            ],
            "groups": [
              {
                "id": "group_123",
                "name": "Developers",
                "created_by": "user_123"
              }
            ]
          },
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "add",
              "id": "add_789",
              "group_id": "group_123",
              "user_id": "nonexistent_user",
              "added_by": "user_123",
              "signature": "dummy_sig_YWRkOmFkZF83ODk6Z3JvdXBfMTIzOm5vbmV4aXN0ZW50X3VzZXI6dXNlcl8xMjM=_by_creator_pub"
            }
          },
          "env": {
            "CRYPTO_MODE": "dummy"
          }
        },
        "then": {
          "db": {
            "adds": []
          }
        }
      },
      {
        "description": "Add blocked when adder doesn't exist",
        "given": {
          "db": {
            "users": [
              {
                "id": "user_456",
                "pubkey": "member_pub",
                "network_id": "net_123"
              }
            ],
            "groups": [
              {
                "id": "group_123",
                "name": "Developers",
                "created_by": "user_123"
              }
            ]
          },
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "add",
              "id": "add_999",
              "group_id": "group_123",
              "user_id": "user_456",
              "added_by": "nonexistent_adder",
              "signature": "dummy_sig_YWRkOmFkZF85OTk6Z3JvdXBfMTIzOnVzZXJfNDU2Om5vbmV4aXN0ZW50X2FkZGVy_by_nonexistent_adder"
            }
          },
          "env": {
            "CRYPTO_MODE": "dummy"
          }
        },
        "then": {
          "db": {
            "adds": []
          }
        }
      },
      {
        "description": "Add blocked when signature is from non-user",
        "given": {
          "db": {
            "users": [
              {
                "id": "user_123",
                "pubkey": "user_pub",
                "network_id": "net_123"
              },
              {
                "id": "user_456",
                "pubkey": "member_pub",
                "network_id": "net_123"
              }
            ],
            "groups": [
              {
                "id": "group_123",
                "name": "Developers",
                "created_by": "user_123"
              }
            ]
          },
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "add",
              "id": "add_fake",
              "group_id": "group_123",
              "user_id": "user_456",
              "added_by": "user_123",
              "signature": "dummy_sig_YWRkOmFkZF9mYWtlOmdyb3VwXzEyMzp1c2VyXzQ1Njp1c2VyXzEyMw==_by_unknown_pub"
            }
          },
          "env": {
            "CRYPTO_MODE": "dummy"
          }
        },
        "then": {
          "db": {
            "adds": []
          }
        }
      },
      {
        "description": "Idempotency - duplicate add doesn't create duplicate state",
        "given": {
          "db": {
            "users": [
              {
                "id": "user_123",
                "pubkey": "user_pub",
                "network_id": "net_123"
              },
              {
                "id": "user_456",
                "pubkey": "other_pub",
                "network_id": "net_123"
              }
            ],
            "groups": [
              {
                "id": "group_123",
                "name": "Developers",
                "created_by": "user_123"
              }
            ],
            "adds": [
              {
                "id": "add_123",
                "group_id": "group_123",
                "user_id": "user_456",
                "added_by": "user_123",
                "created_at_ms": 0
              }
            ],
            "event_store": [
              {
                "event_type": "add",
                "data": {
                  "type": "add",
                  "id": "add_123",
                  "group_id": "group_123",
                  "user_id": "user_456",
                  "added_by": "user_123",
                  "signature": "dummy_sig_YWRkOmFkZF8xMjM6Z3JvdXBfMTIzOnVzZXJfNDU2OnVzZXJfMTIz_by_creator_pub"
                },
                "metadata": {}
              }
            ]
          },
          "envelope": {
            "metadata": {},
            "payload": {
              "type": "add",
              "id": "add_123",
              "group_id": "group_123",
              "user_id": "user_456",
              "added_by": "user_123",
              "signature": "dummy_sig_YWRkOmFkZF8xMjM6Z3JvdXBfMTIzOnVzZXJfNDU2OnVzZXJfMTIz_by_creator_pub"
            }
          },
          "env": {
            "CRYPTO_MODE": "dummy"
          }
        },
        "then": {
          "db": {
            "adds": [
              {
                "id": "add_123",
                "group_id": "group_123",
                "user_id": "user_456",
                "added_by": "user_123"
              }
            ]
          }
        }
      }
    ]
  },
  "commands": {
    "create": {
      "description": "Adds a user to a group",
      "func": "create.execute",
      "tests": [
        {
          "given": {
            "db": {
              "identities": [
                {
                  "pubkey": "creator_pub",
                  "privkey": "creator_priv",
                  "name": "Alice"
                }
              ],
              "users": [
                {
                  "id": "user_123",
                  "pubkey": "creator_pub",
                  "network_id": "net_123",
                  "name": "Alice"
                },
                {
                  "id": "user_456",
                  "pubkey": "member_pub",
                  "network_id": "net_123",
                  "name": "Bob"
                }
              ],
              "groups": [
                {
                  "id": "group_123",
                  "name": "Developers",
                  "created_by": "user_123"
                }
              ]
            },
            "params": {
              "user_id": "user_456",
              "group_id": "group_123",
              "added_by": "user_123"
            },
            "env": {
              "CRYPTO_MODE": "dummy"
            }
          },
          "then": {
            "return": {
              "api_response": {
                "addId": "*",
                "userId": "user_456",
                "groupId": "group_123"
              },
              "newEvents": [
                {
                  "type": "add",
                  "id": "*",
                  "user_id": "user_456",
                  "group_id": "group_123",
                  "added_by": "user_123",
                  "signature": "dummy_sig_YWRkOio6Z3JvdXBfMTIzOnVzZXJfNDU2OnVzZXJfMTIz_by_creator_pub"
                }
              ]
            }
          }
        },
        {
          "description": "Member can add another user",
          "given": {
            "db": {
              "identities": [
                {
                  "pubkey": "member1_pub",
                  "privkey": "member1_priv",
                  "name": "Bob"
                }
              ],
              "users": [
                {
                  "id": "user_123",
                  "pubkey": "creator_pub",
                  "network_id": "net_123"
                },
                {
                  "id": "user_456",
                  "pubkey": "member1_pub",
                  "network_id": "net_123"
                },
                {
                  "id": "user_789",
                  "pubkey": "member2_pub",
                  "network_id": "net_123"
                }
              ],
              "groups": [
                {
                  "id": "group_123",
                  "name": "Developers",
                  "created_by": "user_123"
                }
              ],
              "adds": [
                {
                  "id": "add_first",
                  "user_id": "user_456",
                  "group_id": "group_123",
                  "added_by": "user_123"
                }
              ]
            },
            "params": {
              "user_id": "user_789",
              "group_id": "group_123",
              "added_by": "user_456"
            },
            "env": {
              "CRYPTO_MODE": "dummy"
            }
          },
          "then": {
            "return": {
              "api_response": {
                "addId": "*",
                "userId": "user_789",
                "groupId": "group_123"
              },
              "newEvents": [
                {
                  "type": "add",
                  "id": "*",
                  "user_id": "user_789",
                  "group_id": "group_123",
                  "added_by": "user_456",
                  "signature": "dummy_sig_YWRkOio6Z3JvdXBfMTIzOnVzZXJfNzg5OnVzZXJfNDU2_by_member_pub"
                }
              ]
            }
          }
        },
        {
          "description": "Fails when group doesn't exist",
          "given": {
            "db": {
              "users": [
                {
                  "id": "user_123",
                  "pubkey": "creator_pub",
                  "network_id": "net_123"
                },
                {
                  "id": "user_456",
                  "pubkey": "member_pub",
                  "network_id": "net_123"
                }
              ]
            },
            "params": {
              "user_id": "user_456",
              "group_id": "unknown_group",
              "added_by": "user_123"
            },
            "env": {
              "CRYPTO_MODE": "dummy"
            }
          },
          "then": {
            "error": "Group unknown_group not found"
          }
        },
        {
          "description": "Fails when adder lacks permission",
          "given": {
            "db": {
              "users": [
                {
                  "id": "user_123",
                  "pubkey": "creator_pub",
                  "network_id": "net_123"
                },
                {
                  "id": "user_456",
                  "pubkey": "member_pub",
                  "network_id": "net_123"
                },
                {
                  "id": "user_789",
                  "pubkey": "non_member_pub",
                  "network_id": "net_123"
                }
              ],
              "groups": [
                {
                  "id": "group_123",
                  "name": "Developers",
                  "created_by": "user_123"
                }
              ]
            },
            "params": {
              "user_id": "user_456",
              "group_id": "group_123",
              "added_by": "user_789"
            },
            "env": {
              "CRYPTO_MODE": "dummy"
            }
          },
          "then": {
            "error": "User user_789 does not have permission to add users to group group_123"
          }
        }
      ]
    }
  }
}
