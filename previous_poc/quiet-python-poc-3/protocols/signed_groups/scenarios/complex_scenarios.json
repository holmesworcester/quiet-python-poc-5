{
  "description": "Complex scenario tests for signed_groups protocol",
  "tests": [
    {
      "description": "Race condition: Two users create groups simultaneously",
      "given": {
        "db": {
          "users": [
            {
              "id": "alice",
              "pubkey": "alice_pub",
              "network_id": "net_123",
              "name": "Alice"
            },
            {
              "id": "bob",
              "pubkey": "bob_pub",
              "network_id": "net_123",
              "name": "Bob"
            }
          ]
        },
        "envelope": [
          {
            "data": {
              "type": "group",
              "id": "group_alice",
              "name": "Alice's Group",
              "created_by": "alice",
              "signature": "dummy_sig_signed_by_alice"
            },
            "metadata": {}
          },
          {
            "data": {
              "type": "group",
              "id": "group_bob",
              "name": "Bob's Group",
              "created_by": "bob",
              "signature": "dummy_sig_signed_by_bob"
            },
            "metadata": {}
          }
        ],
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "then": {
        "db": {
          "groups": [
            {
              "id": "group_alice",
              "name": "Alice's Group",
              "created_by": "alice"
            },
            {
              "id": "group_bob",
              "name": "Bob's Group",
              "created_by": "bob"
            }
          ],
          "first_group_id": "group_alice"
        }
      }
    },
    {
      "description": "Cascading unblock: User unblocks group which unblocks channel which unblocks message",
      "given": {
        "db": {
          "networks": [
            {
              "id": "net_123",
              "name": "Test Network",
              "creator_pubkey": "creator_pub"
            }
          ],
          "blocked": [
            {
              "event_id": "group_123",
              "blocked_by_id": "user_creator",
              "event_type": "group",
              "data": "{\"type\": \"group\", \"id\": \"group_123\", \"name\": \"Group 123\", \"created_by\": \"user_creator\", \"signature\": \"dummy_sig_signed_by_user_creator\"}",
              "metadata": "{}",
              "reason": "User user_creator not found",
              "created_at_ms": 100
            },
            {
              "event_id": "channel_123",
              "blocked_by_id": "group_123",
              "event_type": "channel",
              "data": "{\"type\": \"channel\", \"id\": \"channel_123\", \"name\": \"General\", \"network_id\": \"net_123\", \"group_id\": \"group_123\", \"created_by\": \"user_creator\", \"signature\": \"dummy_sig_signed_by_user_creator\"}",
              "metadata": "{}",
              "reason": "Group group_123 not found",
              "created_at_ms": 200
            },
            {
              "event_id": "msg_123",
              "blocked_by_id": "channel_123",
              "event_type": "message",
              "data": "{\"type\": \"message\", \"id\": \"msg_123\", \"channel_id\": \"channel_123\", \"author_id\": \"user_creator\", \"peer_id\": \"user_creator\", \"user_id\": \"user_creator\", \"content\": \"Hello\", \"signature\": \"dummy_sig_signed_by_user_creator\"}",
              "metadata": "{}",
              "reason": "Channel channel_123 not found",
              "created_at_ms": 300
            }
          ]
        },
        "envelope": {
          "data": {
            "type": "user",
            "id": "user_creator",
            "network_id": "net_123",
            "pubkey": "creator_pub",
            "name": "Creator",
            "signature": "dummy_sig"
          },
          "metadata": {}
        },
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "ticks": 5,
      "then": {
        "db": {
          "users": [
            {
              "id": "user_creator"
            }
          ],
          "groups": [
            {
              "id": "group_123"
            }
          ],
          "channels": [
            {
              "id": "channel_123"
            }
          ],
          "messages": [
            {
              "id": "msg_123"
            }
          ],
          "blocked": []
        }
      }
    },
    {
      "description": "Multiple invites to same group with race condition",
      "given": {
        "db": {
          "users": [
            {
              "id": "alice",
              "pubkey": "alice_pub",
              "network_id": "net_123",
              "name": "Alice"
            },
            {
              "id": "bob",
              "pubkey": "bob_pub",
              "network_id": "net_123",
              "name": "Bob"
            }
          ],
          "groups": [
            {
              "id": "group_123",
              "name": "Test Group",
              "created_by": "alice"
            }
          ],
          "adds": [
            {
              "id": "add_alice",
              "user_id": "alice",
              "group_id": "group_123",
              "added_by": "alice"
            },
            {
              "id": "add_bob",
              "user_id": "bob",
              "group_id": "group_123",
              "added_by": "alice"
            }
          ]
        },
        "envelope": [
          {
            "data": {
              "type": "invite",
              "id": "invite_1",
              "invite_pubkey": "invite_pub_1",
              "network_id": "net_123",
              "group_id": "group_123",
              "created_by": "alice",
              "signature": "dummy_sig_signed_by_alice"
            },
            "metadata": {}
          },
          {
            "data": {
              "type": "invite",
              "id": "invite_2",
              "invite_pubkey": "invite_pub_2",
              "network_id": "net_123",
              "group_id": "group_123",
              "created_by": "bob",
              "signature": "dummy_sig_signed_by_bob"
            },
            "metadata": {}
          }
        ],
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "then": {
        "db": {
          "invites": [
            {
              "id": "invite_1",
              "invite_pubkey": "invite_pub_1",
              "network_id": "net_123",
              "group_id": "group_123",
              "created_by": "alice"
            },
            {
              "id": "invite_2",
              "invite_pubkey": "invite_pub_2",
              "network_id": "net_123",
              "group_id": "group_123",
              "created_by": "bob"
            }
          ]
        }
      }
    },
    {
      "description": "First group enforcement with multiple groups created out of order",
      "given": {
        "db": {
          "networks": [
            {
              "id": "net_123",
              "name": "Test Network",
              "creator_pubkey": "creator_pub"
            }
          ],
          "users": [
            {
              "id": "user_creator",
              "pubkey": "creator_pub",
              "network_id": "net_123",
              "name": "Creator"
            },
            {
              "id": "user_alice",
              "pubkey": "alice_pub",
              "network_id": "net_123",
              "name": "Alice"
            }
          ],
          "groups": [
            {
              "id": "group_second",
              "name": "Second Group",
              "created_by": "user_alice",
              "created_at_ms": 2000
            }
          ],
          "invites": [
            {
              "id": "invite_first",
              "invite_pubkey": "invite_pub_first",
              "network_id": "net_123",
              "group_id": "group_first"
            },
            {
              "id": "invite_second",
              "invite_pubkey": "invite_pub_second",
              "network_id": "net_123",
              "group_id": "group_second"
            }
          ],
          "blocked": [
            {
              "event_id": "user_wrong",
              "blocked_by_id": "first_group_group_first",
              "event_type": "user",
              "data": "{\"type\": \"user\", \"id\": \"user_wrong\", \"network_id\": \"net_123\", \"group_id\": \"group_second\", \"pubkey\": \"wrong_pub\", \"name\": \"Wrong User\", \"invite_id\": \"invite_second\", \"invite_signature\": \"dummy_invite_sig\", \"signature\": \"dummy_sig\"}",
              "metadata": "{}",
              "reason": "Must join first group: group_first",
              "created_at_ms": 1500
            }
          ]
        },
        "envelope": {
          "data": {
            "type": "group",
            "id": "group_first",
            "name": "First Group",
            "created_by": "user_creator",
            "signature": "dummy_sig_signed_by_user_creator"
          },
          "metadata": {}
        },
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "ticks": 3,
      "then": {
        "db": {
          "groups": [
            {
              "id": "group_first",
              "name": "First Group",
              "created_by": "user_creator"
            },
            {
              "id": "group_second"
            }
          ],
          "first_group_id": "group_first",
          "users": [
            {
              "id": "user_creator"
            },
            {
              "id": "user_alice"
            },
            {
              "id": "user_wrong",
              "group_id": "group_first"
            }
          ]
        }
      }
    },
    {
      "description": "Cross-group message blocking due to channel access",
      "given": {
        "db": {
          "users": [
            {
              "id": "alice",
              "pubkey": "alice_pub",
              "network_id": "net_123",
              "name": "Alice"
            },
            {
              "id": "bob",
              "pubkey": "bob_pub",
              "network_id": "net_123",
              "name": "Bob"
            }
          ],
          "groups": [
            {
              "id": "group_a",
              "name": "Group A",
              "created_by": "alice"
            },
            {
              "id": "group_b",
              "name": "Group B",
              "created_by": "bob"
            }
          ],
          "channels": [
            {
              "id": "channel_a",
              "name": "Channel A",
              "network_id": "net_123",
              "group_id": "group_a",
              "created_by": "alice"
            }
          ],
          "adds": [
            {
              "id": "add_alice_a",
              "user_id": "alice",
              "group_id": "group_a",
              "added_by": "alice"
            },
            {
              "id": "add_bob_b",
              "user_id": "bob",
              "group_id": "group_b",
              "added_by": "bob"
            }
          ]
        },
        "envelope": {
          "data": {
            "type": "message",
            "id": "msg_bob_blocked",
            "channel_id": "channel_a",
            "author_id": "bob",
            "peer_id": "bob",
            "user_id": "bob",
            "content": "Hello from Bob",
            "signature": "dummy_sig_signed_by_bob"
          },
          "metadata": {}
        },
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "then": {
        "db": {
          "messages": [],
          "blocked": [
            {
              "event_id": "msg_bob_blocked",
              "blocked_by_id": "channel_access_channel_a",
              "event_type": "message",
              "reason": "Author bob has no access to channel channel_a"
            }
          ]
        }
      }
    },
    {
      "description": "Add event creates chain reaction of unblocks",
      "given": {
        "db": {
          "users": [
            {
              "id": "alice",
              "pubkey": "alice_pub",
              "network_id": "net_123",
              "name": "Alice"
            },
            {
              "id": "bob",
              "pubkey": "bob_pub",
              "network_id": "net_123",
              "name": "Bob"
            }
          ],
          "groups": [
            {
              "id": "group_123",
              "name": "Test Group",
              "created_by": "alice"
            }
          ],
          "channels": [
            {
              "id": "channel_123",
              "name": "General",
              "network_id": "net_123",
              "group_id": "group_123",
              "created_by": "alice"
            }
          ],
          "adds": [
            {
              "id": "add_alice",
              "user_id": "alice",
              "group_id": "group_123",
              "added_by": "alice"
            }
          ],
          "blocked": [
            {
              "event_id": "msg_1",
              "blocked_by_id": "channel_access_channel_123",
              "event_type": "message",
              "data": "{\"type\": \"message\", \"id\": \"msg_1\", \"channel_id\": \"channel_123\", \"author_id\": \"bob\", \"peer_id\": \"bob\", \"user_id\": \"bob\", \"content\": \"Hello\", \"signature\": \"dummy_sig_signed_by_bob\"}",
              "metadata": "{}",
              "reason": "Author bob has no access to channel channel_123",
              "created_at_ms": 100
            },
            {
              "event_id": "msg_2",
              "blocked_by_id": "channel_access_channel_123",
              "event_type": "message",
              "data": "{\"type\": \"message\", \"id\": \"msg_2\", \"channel_id\": \"channel_123\", \"author_id\": \"bob\", \"peer_id\": \"bob\", \"user_id\": \"bob\", \"content\": \"Is anyone here?\", \"signature\": \"dummy_sig_signed_by_bob\"}",
              "metadata": "{}",
              "reason": "Author bob has no access to channel channel_123",
              "created_at_ms": 200
            }
          ]
        },
        "envelope": {
          "data": {
            "type": "add",
            "id": "add_bob",
            "user_id": "bob",
            "group_id": "group_123",
            "added_by": "alice",
            "signature": "dummy_sig_signed_by_alice"
          },
          "metadata": {}
        },
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "ticks": 3,
      "then": {
        "db": {
          "adds": [
            {
              "id": "add_alice"
            },
            {
              "id": "add_bob"
            }
          ],
          "messages": [
            {
              "id": "msg_1",
              "content": "Hello"
            },
            {
              "id": "msg_2",
              "content": "Is anyone here?"
            }
          ],
          "blocked": []
        }
      }
    },
    {
      "description": "Network handoff scenario: Creator leaves, new user becomes admin",
      "given": {
        "db": {
          "networks": [
            {
              "id": "net_123",
              "name": "Test Network",
              "creator_pubkey": "creator_pub"
            }
          ],
          "users": [
            {
              "id": "creator",
              "pubkey": "creator_pub",
              "network_id": "net_123",
              "name": "Creator"
            },
            {
              "id": "alice",
              "pubkey": "alice_pub",
              "network_id": "net_123",
              "name": "Alice"
            },
            {
              "id": "bob",
              "pubkey": "bob_pub",
              "network_id": "net_123",
              "name": "Bob"
            }
          ],
          "groups": [
            {
              "id": "group_main",
              "name": "Main Group",
              "created_by": "creator"
            }
          ],
          "adds": [
            {
              "id": "add_creator",
              "user_id": "creator",
              "group_id": "group_main",
              "added_by": "creator"
            },
            {
              "id": "add_alice",
              "user_id": "alice",
              "group_id": "group_main",
              "added_by": "creator"
            },
            {
              "id": "add_bob",
              "user_id": "bob",
              "group_id": "group_main",
              "added_by": "alice"
            }
          ]
        },
        "envelope": [
          {
            "data": {
              "type": "group",
              "id": "group_new",
              "name": "New Group After Creator Left",
              "created_by": "alice",
              "signature": "dummy_sig_signed_by_alice"
            },
            "metadata": {}
          },
          {
            "data": {
              "type": "channel",
              "id": "channel_new",
              "name": "New Channel",
              "network_id": "net_123",
              "group_id": "group_new",
              "created_by": "bob",
              "signature": "dummy_sig_signed_by_bob"
            },
            "metadata": {}
          }
        ],
        "env": {
          "CRYPTO_MODE": "dummy"
        }
      },
      "then": {
        "db": {
          "groups": [
            {
              "id": "group_main"
            },
            {
              "id": "group_new",
              "created_by": "alice"
            }
          ],
          "channels": [
            {
              "id": "channel_new",
              "created_by": "bob"
            }
          ]
        }
      }
    }
  ]
}