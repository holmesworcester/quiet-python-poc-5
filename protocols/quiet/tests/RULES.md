# Test Rules and Guidelines

## Test Categories

### 1. Command Tests (`tests/events/*/test_command.py`)
**Purpose**: Test that command functions create proper envelope structures with correct event data.

**What to test:**
- Command functions return properly structured envelopes
- Required parameters are validated
- Event data contains expected fields
- Event type is correct
- Dependencies are properly declared

**What NOT to test:**
- Generated IDs (these will be empty strings `""` until handlers process them)
- Database state (commands don't touch the database)
- Event relationships (commands just create envelopes)

**Example patterns:**
```python
def test_create_group_basic(self):
    envelope = create_group({"name": "Test"})

    # Check envelope structure
    assert envelope["event_type"] == "group"

    # Check event data
    event = envelope["event_plaintext"]
    assert event["name"] == "Test"
    assert event["group_id"] == ""  # Empty until handlers process
```

### 2. Query Tests (`tests/events/*/test_query.py`)
**Purpose**: Test query functions that read from database.

**Setup requirements:**
- Must use fixtures that directly insert data into database
- Should NOT use command functions to create test data (they don't create valid IDs)
- Use SQL INSERT statements or test helpers that bypass the pipeline

**Example patterns:**
```python
@pytest.fixture
def setup_groups(self, db_conn):
    # Directly insert test data
    db_conn.execute("""
        INSERT INTO groups (group_id, name, network_id, creator_id)
        VALUES ('group-1', 'Test Group', 'network-1', 'user-1')
    """)
    db_conn.commit()
```

### 3. Handler Tests (`tests/handlers/test_*.py`)
**Purpose**: Test individual handlers in isolation.

**What to test:**
- Handler processes envelopes correctly
- Handler modifies envelope fields as expected
- Handler interacts with database properly
- Handler filters work correctly

### 4. Integration Tests (`tests/integration/test_*.py`)
**Purpose**: Test full command execution through the pipeline.

**What to test:**
- Commands execute through full pipeline
- Database state after command execution
- Event storage and projections
- Multiple related commands work together

**Setup:**
- Use PipelineRunner or API client
- Commands go through all handlers
- IDs are properly generated

## Common Pitfalls to Avoid

1. **Don't expect IDs in command tests**
   - Commands return envelopes with empty ID fields
   - IDs are generated by handlers (like event_crypto)

2. **Don't use commands to set up query test data**
   - Commands return unprocessed envelopes
   - Query tests need actual database data with valid IDs

3. **Don't test pipeline behavior in unit tests**
   - Unit tests should test one thing in isolation
   - Integration tests are for pipeline behavior

4. **Don't assume event relationships in command tests**
   - Commands just declare dependencies
   - Handlers resolve and validate relationships

## Test Markers

- `@pytest.mark.unit` - Unit tests for single components
- `@pytest.mark.event_type` - Tests for event type commands/validators
- `@pytest.mark.handler` - Tests for individual handlers
- `@pytest.mark.integration` - Tests requiring full pipeline